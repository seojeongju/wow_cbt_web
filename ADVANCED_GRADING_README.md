# 고급 채점 기준 기능 (Advanced Grading Criteria)

## 개요

모의고사 출제 시 **카테고리별 과락 설정** 및 전체 평균점수 기준 설정 기능이 추가되었습니다.

## 주요 기능

### 1. 전체 합격 점수
- 기존 기능 유지
- 전체 문제 중 일정 비율 이상 맞춰야 합격
- 기본값: 60점

### 2. 평균 점수 기준 (새 기능) ✨
- 모든 카테고리의 평균 점수가 기준 이상이어야 합격
- 체크박스로 활성화/비활성화 가능
- 기본값: 60점
- 사용 시나리오:
  - 모든 카테고리를 고르게 학습했는지 확인
  - 특정 카테고리에 편중되지 않았는지 검증

### 3. 카테고리별 과락 설정 (새 기능) ✨
- 각 카테고리마다 최소 득점 기준 설정 가능
- 체크박스로 활성화/비활성화 가능
- 기본값: 각 카테고리당 40점
- 동적으로 카테고리 목록 표시 (문제에서 자동 추출)
- 사용 시나리오:
  - 중요 카테고리에 대한 최소 이해도 보장
  - 카테고리별 불균형 방지

## 사용 방법

### 모의고사 생성 시

1. **Step 1**: 문제 선택
   - 기존과 동일하게 과정, 과목, 카테고리로 필터링
   - 원하는 문제 선택

2. **Step 2**: 출제 옵션
   - 수동 출제 또는 자동 출제 선택
   - 기존과 동일

3. **Step 3**: 시험 설정 (새 UI 추가)
   - 시험 제목 입력
   - 시간 제한 설정
   - **전체 합격 점수** 설정 (필수)
   
   **평균 점수 기준** (선택)
   - ☑️ "평균 점수 기준 사용" 체크
   - 평균 합격 점수 입력 (0-100)
   - 설명: 모든 과목의 평균 점수가 기준 이상이어야 합격
   
   **카테고리별 과락 기준** (선택)
   - ☑️ "카테고리별 과락 기준 사용" 체크
   - 각 카테고리별로 최소 점수 설정
   - 카테고리별 문제 수 자동 표시

4. **Step 4**: 미리보기 및 생성
   - 설정 확인 후 생성

### 합격 판정 로직

시험 응시 후 다음 순서로 합격 여부 판정:

1. **카테고리별 과락 체크** (활성화된 경우)
   - 각 카테고리 점수 계산 (100점 만점)
   - 설정된 최소 점수 미달 시 불합격
   - 불합격 사유: "OO 카테고리 과락 (XX점 < YY점)"

2. **평균 점수 체크** (활성화된 경우)
   - 모든 과목 점수의 평균 계산
   - 평균이 기준 미달 시 불합격
   - 불합격 사유: "평균 점수 미달 (XX점 < YY점)"

3. **전체 합격 점수 체크**
   - 전체 점수가 기준 미달 시 불합격
   - 불합격 사유: "전체 점수 미달 (XX점 < YY점)"

모든 조건을 통과해야 최종 합격입니다.

## 데이터베이스 구조

### Exams 테이블
```sql
-  average_pass_score: INTEGER -- 평균 합격 점수 (null이면 미사용)
- use_average_score: INTEGER -- 평균 점수 기준 사용 여부 (0/1)
- category_min_scores: TEXT -- JSON: {"category": minScore, ...}
- use_category_min_score: INTEGER -- 카테고리별 과락 사용 여부 (0/1)
```

### Questions 테이블
```sql
- subject_id: TEXT -- 과목 ID (과목별 채점용)
```

### Exam Results 테이블
```sql
- category_scores: TEXT -- JSON: {"category": score, ...}
- average_score: REAL -- 평균 점수
- fail_reasons: TEXT -- JSON: ["reason1", "reason2", ...]
```

## API 변경사항

### POST /api/exams/generate

**요청 (추가된 필드)**
```json
{
  "title": "모의고사 제목",
  "courseId": "course_id",
  "questionIds": ["q1", "q2", ...],
  // ... 기존 필드들 ...
  
  // 새 필드
  "gPassScore": 60,
  "useAverageScore": true,
  "categoryMinScores": {
    "카테고리1": 40,
    "카테고리2": 50
  },
  "useCategoryMinScore": true
}
```

## 마이그레이션

데이터베이스 스키마 업데이트:
```bash
# D1 데이터베이스에 마이그레이션 적용
wrangler d1 execute [DATABASE_NAME] --file=migration_add_grading_criteria.sql
```

## 예제 시나리오

### 시나리오 1: 기본 설정 (기존과 동일)
- 전체 합격 점수: 60점
- 평균 점수 기준: 사용 안 함
- 과목별 과락: 사용 안 함

→ 전체 60점 이상이면 합격

### 시나리오 2: 평균 중시
- 전체 합격 점수: 60점
- 평균 점수 기준: 60점 (사용)
- 카테고리별 과락: 사용 안 함

→ 전체 60점 이상 + 카테고리 평균 60점 이상이면 합격

### 시나리오 3: 엄격한 기준
- 전체 합격 점수: 70점
- 평균 점수 기준: 60점 (사용)
- 카테고리별 과락: 각 카테고리 40점 이상 (사용)

→ 세 가지 조건 모두 충족해야 합격
- 예: 카테고리 A(90점), 카테고리 B(30점) = 평균 60점, 전체 60점
  - 결과: 불합격 (카테고리 B 과락)

## 향후 개선 사항

1. 시험 결과 페이지에 상세 피드백 표시
2. 카테고리별 점수 그래프 시각화
3. 불합격 사유별 통계
4. 카테고리별 난이도 조정 기능

## 파일 변경 내역

- `src/types/index.ts` - Question, Exam, ExamResult 인터페이스 확장
- `src/pages/admin/MockExamGenerator.tsx` - UI 및 로직 추가
- `src/services/examService.ts` - API 파라미터 타입 업데이트
- `functions/api/exams/generate.js` - 백엔드 API 업데이트
- `migration_add_grading_criteria.sql` - 데이터베이스 마이그레이션
- `ADVANCED_GRADING_README.md` - 이 문서
